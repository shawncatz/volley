#!/usr/bin/env ruby

require 'rubygems'
require 'volley'
require 'clamp'

#Volley::VolleyFile.init

module Volley
  class Command < Clamp::Command
    self.default_subcommand = "list"
    option %w{-c --config}, "CONFIG", "configuration file", :default => "~/.Volleyfile"
    option %w{-p --primary}, "PRIMARY", "primary configuration file", :default => "Volleyfile"
    option %w{-d --debug}, :flag, "set debug flag"

    def load_volleyfiles
      raise "could not locate Volleyfile" unless File.exists?(primary)
      Volley::VolleyFile.load(config, :optional => true)
      Volley::VolleyFile.load(primary, :primary => true)
    end

    subcommand "list", "list projects and plans from local Volleyfile" do
      def execute
        load_volleyfiles
        Volley::Dsl::Project.projects.each do |p, project|
          Volley::Log.info "project: #{p}"
          project.plans.each do |pl, plan|
           Volley::Log.info ".. #{pl}"
          end
        end
      rescue Interrupt => e
        Volley::Log.warn "Cancelled..."
      rescue => e
        Volley::Log.error "error: #{e.message}"
        Volley::Log.error e if debug?
        raise Clamp::HelpWanted, self
      end
    end

    subcommand "versions", "get version list of project or project:plan from remote data store" do
      #parameter "PROJECTPLAN", "project and plan to run, of the form project:plan"
      #option %w{-l --local}, :flag, "display information about projects and plans for Volleyfile"

      def execute
        load_volleyfiles
        if remote?
          (project, branch) = remote.split(/:/)
          if project
            if branch
              # show project/branch versions
            else
              # show project names
            end
          else
            # show projects
          end
        else
        end
      rescue Interrupt => e
        Volley::Log.warn "Cancelled..."
      rescue => e
        Volley::Log.error "error: #{e.message}"
        Volley::Log.error e if debug?
        raise Clamp::HelpWanted, self
      end
    end
    subcommand "get", "get an artifact from the data store and run it" do
      option %w{-f --fork}, :flag, "fork process into background"
      parameter "GET", "<project>:<branch>[:<version>]:plan"
      parameter "[ARG] ...", "additional arguments passed to plan of the form: key:value"
      def execute
        load_volleyfiles

        (project, branch, version, plan) = get.split(/[\/:\.\-]/)
        unless plan
          plan    = version
          version = "latest"
        end
        if debug?
          puts "project: #{project}"
          puts "branch:    #{branch}"
          puts "version: #{version}"
          puts "plan:    #{plan}"
        end
        pub = Volley::Dsl.publisher
        file = pub.pull(project, branch, version)
        dir = File.dirname(file)
        Volley::Log.info "changing directory: #{dir} (#{file})"
        cmd = "volley run #{project}:#{plan} branch:#{branch} #{arg_list.join(' ')}"
        Volley::Log.info "command: #{cmd}"
        FileUtils.mkdir_p("#{dir}/unpack")
        Dir.chdir("#{dir}/unpack")
        tgz = %x{tar xvfz #{file} 2>/dev/null}
        File.open("#{dir}/tgz.log", "w") {|f| f.write(tgz)}
        exec(cmd)
      rescue Interrupt => e
        Volley::Log.warn "Cancelled..."
      rescue => e
        Volley::Log.error "error: #{e.message}"
        Volley::Log.error e if debug?
        raise Clamp::HelpWanted, self
      end
    end
    subcommand "run", "run a project:plan from local Volleyfile" do
      option %w{-f --fork}, :flag, "fork process into background"
      parameter "PROJECTPLAN", "project and plan to run, of the form project:plan"
      parameter "[ARG] ...", "additional arguments passed to plan of the form: key:value"

      def execute
        load_volleyfiles

        (project, plan) = projectplan.split(/:/)
        project         = project.to_sym
        plan = plan.to_sym if plan

        Volley.config.debug = debug?

        if debug?
          puts "project:   #{project} #{Volley::Dsl.project(project)}"
          puts "plan:      #{plan}"
          puts "args_list: #{arg_list.join(",")}"
        end

        raise "you must specify project: [#{Volley::Dsl.projects.keys.join(',')}]" unless project && Volley::Dsl.project(project)
        raise "you must specify plan: #{project} [#{Volley::Dsl::Project.project(project).plans.keys.join(", ")}]" unless plan && Volley::Dsl::Project.project(project).plan(plan)

        Volley::Dsl::Project.project(project).plan(plan).call(:cliargs => arg_list)
      rescue Interrupt => e
        Volley::Log.warn "Cancelled..."
      rescue => e
        Volley::Log.error "error: #{e.message}"
        Volley::Log.error e if debug?
        raise Clamp::HelpWanted, self
      end
    end
  end
end

Volley::Command.run