project "inqcloud"

plan :push do
  encrypt true, :key => "this is the key", :overwrite => false
  output false

  argument :name
  argument :clean, :default => true, :convert => :boolean
  argument :skiptest, :default => false, :convert => :boolean

  build do |attr|
    skiptest = args.skiptest ? 1 : 0
    clean = args.clean ? 1 : 0

    #TODO: remove this once the Volleyfile becomes part of inqcloud repo
    root = "#{ENV['HOME']}/work/inqcloud/trunk"
    Dir.chdir(root)

    shellout("rake maven[#{skiptest},#{clean}]")

    # get version number
    build = shellout("rake version")[:out].chomp
    m = build.match(/^(\w+)-(\w+).(\w+)$/)
    raise "error getting build values" unless m
    (_, branch, revision) = m[1..3]

    args.name ||= branch
    args.version = revision

    final = "#{root}/target/#{build}.war"
    [final]
  end

  push :amazons3
end

plan :deploy do
  pull :amazons3
end
